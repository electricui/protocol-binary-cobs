import 'mocha'

import * as chai from 'chai'

import { decode } from '../src/cobs'

const assert = chai.assert

function generateDecoderEqualityTest(testCase: Buffer, reference: Buffer) {
  return () => {
    const out = decode(testCase)

    assert.deepEqual(out, reference)
  }
}

describe('COBS Decoder (assumes 0x00s are removed in a previous split operation)', () => {
  it(
    'correctly decodes a single 0x00',
    generateDecoderEqualityTest(Buffer.from([0x01, 0x01]), Buffer.from([0x00])),
  )
  it(
    'correctly decodes two 0x00s',
    generateDecoderEqualityTest(
      Buffer.from([0x01, 0x01, 0x01]),
      Buffer.from([0x00, 0x00]),
    ),
  )
  it(
    'correctly decodes 0x11 22 00 33',
    generateDecoderEqualityTest(
      Buffer.from([0x03, 0x11, 0x22, 0x02, 0x33]),
      Buffer.from([0x11, 0x22, 0x00, 0x33]),
    ),
  )
  it(
    'correctly decodes 0x11 22 33 44',
    generateDecoderEqualityTest(
      Buffer.from([0x05, 0x11, 0x22, 0x33, 0x44]),
      Buffer.from([0x11, 0x22, 0x33, 0x44]),
    ),
  )

  it(
    'correctly decodes a large Buffer (> 255 bytes)',
    generateDecoderEqualityTest(
      Buffer.from([
        0xff,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0xee,
        0x03,
        0xee,
        0xee,
      ]),

      Buffer.from(Array(257).join('ee'), 'hex'),
    ),
  )
})
